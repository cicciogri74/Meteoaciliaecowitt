<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Stazioni Meteo</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f0f8ff; }
    .card { background: white; padding: 1rem; border-radius: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 1rem; }
    h1, h2 { color: #0077b6; }
    .weather-icon { width: 32px; vertical-align: middle; }
    #map { height: 400px; margin: 2rem 0; border-radius: 1rem; }
    canvas { max-width: 100%; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { padding: 0.5rem; text-align: center; border-bottom: 1px solid #ccc; }
    .alert { background: #ffdddd; padding: 1rem; border: 1px solid red; color: darkred; border-radius: 0.5rem; margin-bottom: 1rem; }
  </style>
</head>
<body>
  <h1>Dashboard Stazioni Meteo</h1>

  <div class="card">
    <label for="stationFilter">Filtra per stazione:</label>
    <select id="stationFilter">
      <option value="all">Tutte</option>
    </select>
  </div>

  <div id="alerts"></div>

  <div class="card" id="comparison">
    <h2>Confronto tra stazioni</h2>
    <table>
      <thead>
        <tr>
          <th>Stazione</th>
          <th>Temperatura (°C)</th>
          <th>Umidità (%)</th>
          <th>Vento (km/h)</th>
        </tr>
      </thead>
      <tbody id="comparisonTable"></tbody>
    </table>
  </div>

  <div id="stationContainer"></div>
  <div id="map" class="card"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const stations = [
      { id: "IROME8355", name: "Roma Nomentano", lat: 41.91, lon: 12.52 },
      { id: "IROME8356", name: "Roma San Giovanni", lat: 41.88, lon: 12.51 }
    ];

    const apiKey = "fe246ce400ae43c2a46ce400ae13c256";
    const stationContainer = document.getElementById("stationContainer");
    const comparisonTable = document.getElementById("comparisonTable");
    const alerts = document.getElementById("alerts");
    const stationFilter = document.getElementById("stationFilter");

    // Populate dropdown
    stations.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s.id;
      opt.textContent = s.name;
      stationFilter.appendChild(opt);
    });

    stationFilter.addEventListener("change", () => {
      const selected = stationFilter.value;
      stations.forEach(s => {
        const el = document.getElementById(`card-${s.id}`);
        if (selected === "all" || selected === s.id) el.classList.remove("hidden");
        else el.classList.add("hidden");
      });
    });

    // Build cards
    stations.forEach(station => {
      const card = document.createElement("div");
      card.className = "card";
      card.id = `card-${station.id}`;
      card.innerHTML = `
        <h2>${station.name}</h2>
        <p><img id="icon-${station.id}" class="weather-icon" src="" alt="" /> <span id="desc-${station.id}">--</span></p>
        <p>Temperatura: <span id="temp-${station.id}">--</span> °C</p>
        <p>Umidità: <span id="hum-${station.id}">--</span> %</p>
        <p>Vento: <span id="wind-${station.id}">--</span> km/h</p>
        <p id="status-${station.id}" class="error" style="color: red;"></p>
        <canvas id="chart-${station.id}" height="100"></canvas>
      `;
      stationContainer.appendChild(card);
    });

    // Map
    const map = L.map("map").setView([41.9, 12.5], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    stations.forEach(station => {
      L.marker([station.lat, station.lon])
        .addTo(map)
        .bindPopup(`<b>${station.name}</b><br>ID: ${station.id}`);
    });

    async function fetchAllData() {
      alerts.innerHTML = "";
      comparisonTable.innerHTML = "";

      stations.forEach(async station => {
        const statusEl = document.getElementById(`status-${station.id}`);
        statusEl.textContent = "";
        try {
          const res = await fetch(`https://api.weather.com/v2/pws/observations/current?stationId=${station.id}&format=json&units=m&apiKey=${apiKey}`);
          const data = await res.json();
          const obs = data.observations[0];

          const temp = obs.metric.temp;
          const hum = obs.humidity;
          const wind = obs.metric.windSpeed;

          document.getElementById(`temp-${station.id}`).textContent = temp;
          document.getElementById(`hum-${station.id}`).textContent = hum;
          document.getElementById(`wind-${station.id}`).textContent = wind;
          document.getElementById(`desc-${station.id}`).textContent = obs.wx_phrase || "Condizioni meteo";
          document.getElementById(`icon-${station.id}`).src = `https://weather.com/static/icons/wu/${obs.icon}.svg`;

          // Notifiche
          if (obs.wx_phrase.toLowerCase().includes("pioggia") || wind > 30) {
            const msg = `⚠️ Attenzione su <b>${station.name}</b>: ${obs.wx_phrase}, vento ${wind} km/h`;
            const div = document.createElement("div");
            div.className = "alert";
            div.innerHTML = msg;
            alerts.appendChild(div);
          }

          // Tabella comparativa
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${station.name}</td>
            <td>${temp}</td>
            <td>${hum}</td>
            <td>${wind}</td>
          `;
          comparisonTable.appendChild(row);

          drawChart(station.id);
        } catch (e) {
          console.error("Errore con", station.id, e);
          statusEl.textContent = "⚠️ Stazione offline o dati non disponibili.";
          const row = document.createElement("tr");
          row.innerHTML = `<td>${station.name}</td><td colspan="3">--</td>`;
          comparisonTable.appendChild(row);
        }
      });
    }

    async function drawChart(stationId) {
      try {
        const res = await fetch(`https://api.weather.com/v2/pws/history/hourly?stationId=${stationId}&format=json&units=m&hours=12&apiKey=${apiKey}`);
        const data = await res.json();
        const temps = data.observations.map(o => o.metric.temp);
        const labels = data.observations.map(o => new Date(o.obsTimeUtc).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
        const ctx = document.getElementById(`chart-${stationId}`).getContext("2d");
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Temperatura °C',
              data: temps,
              borderColor: '#0077b6',
              backgroundColor: 'rgba(0, 119, 182, 0.1)',
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: false } }
          }
        });
      } catch (e) {
        console.warn("Errore grafico per", stationId, e);
      }
    }

    fetchAllData();
    setInterval(fetchAllData, 300000); // ogni 5 min
  </script>
</body>
</html>
